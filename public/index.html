<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poedjangga Tani</title>
    <link rel="icon" href="assets/img/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    
</head>
<body>
<nav class="navbar navbar-expand-lg sticky-top px-3">
  <div class="container-fluid d-flex justify-content-between align-items-center">


    <a class="navbar-brand text-white fw-bold" href="#home">Poedjangga Tani</a>


    <div class="d-lg-none d-flex align-items-center gap-2">
  
    <button class="navbar-toggler me-2 border-0 bg-white rounded shadow-sm px-2 py-1"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarContent"
        aria-controls="navbarContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
        style="transition: all 0.3s ease;">
  <span class="navbar-toggler-icon"></span>
</button>

    
      <div class="dropdown">
        <a class="text-white nav-link dropdown-toggle d-flex align-items-center" href="#" role="button"
          data-bs-toggle="dropdown" aria-expanded="false">
          <i class="fa-solid fa-circle-user fa-lg me-1"></i>
        </a>
        <ul class="dropdown-menu dropdown-menu-end shadow-sm" style="min-width: 180px;">
          <li><a class="dropdown-item" href="profil.html"><i class="fa-solid fa-user me-2"></i> Profil</a></li>
          <li><a class="dropdown-item" href="keranjang.html"><i class="fa-solid fa-cart-shopping me-2"></i> Keranjang</a></li>
          <li><a class="dropdown-item" href="riwayat.html"><i class="fa-solid fa-box me-2"></i> Pesanan Saya</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
  <i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
        </ul>
      </div>
    </div>


    <div class="collapse navbar-collapse" id="navbarContent">

      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link text-white" href="#home">Beranda</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="#produk">Produk</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="about.html">Tentang</a></li>
      </ul>

  
      <form class="d-flex mx-auto w-50 justify-content-center" role="search" onsubmit="event.preventDefault(); filterCards();">
        <div class="input-group w-100">
          <input type="text" class="form-control" placeholder="Cari produk segar..." id="cari" onkeyup="filterCards()">
          <button class="btn btn-light" type="button" onclick="filterCards()">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </div>
      </form>


  
      <ul class="navbar-nav ms-auto d-none d-lg-flex">
        <li class="nav-item dropdown">
          <li class="nav-item me-3 position-relative">
            <a href="#" class="nav-link text-white" onclick="toggleRiwayatPopup()" id="btnRiwayatPopup">
              <i class="fa-solid fa-box me-2 fa-lg"></i>
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="riwayatCount">0</span>
            </a>
          </li>

          <li class="nav-item me-3 position-relative">
          <a href="#" class="nav-link text-white" onclick="toggleKeranjangPopup()" id="btnKeranjangPopup">
        <i class="fa-solid fa-cart-shopping fa-lg"></i>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="keranjangCount" >0</span>
        </a>
        </li>

          <a class="nav-link dropdown-toggle d-flex align-items-center text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa-solid fa-circle-user fa-lg me-1"></i>
            <span class="d-none d-md-inline text-white" id="namaNavbar">Akun</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm" style="min-width: 180px;">
            <li><a class="dropdown-item" href="profil.html"><i class="fa-solid fa-user me-2"></i> Profil</a></li>
            <li><a class="dropdown-item" href="keranjang.html"><i class="fa-solid fa-cart-shopping me-2"></i> Keranjang</a></li>
            <li><a class="dropdown-item" href="riwayat.html"><i class="fa-solid fa-box me-2"></i> Pesanan Saya</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><button onclick="logout()" class="dropdown-item text-danger"><i class="fa-solid fa-right-from-bracket" style="color: #e60000;"></i> Logout</button></li>
          </ul>
        </li>
      </ul>
    </div>

  </div>
</nav>

        <section class="hero container-fluid" id="home">
            <div class="row align-items-center mb-4">
              <div class="col-md-6">
                <h1 class="fw-bold text-custom">"Belanja hasil tani jadi lebih mudah"
                </h1>
                <p class=" text-mute mt-3">"Buah segar, sayur manis, dan tanpa ribet ke pasar. Di Poedjangga Tani, semua hasil bumi langsung dari tangan petani sampai ke pintu rumahmu. Nggak perlu rebutan cabe atau antre panjang, cukup klik dan panenan terbaik siap diantar."</p>
                <a href="#produk" class="btn btn-custom1 mt-3">Yuk Beli Sekarang</a>
              </div>
              <div class="col-md-6 text-center">
                <img src="assets/img/logo.png" alt="Sayur" class="img-fluid">
              </div>
            </div>
          </section>
          


    <div class="container my-4" id="produk">
        <div class="d-flex justify-content-center mb-4">
          <div class="btn-group" role="group" aria-label="Switch Produk">
            <a href="#produk" class="btn btn-switch active" id="btnSayur" onclick="switchSection('sayur')"><i class="fa-solid fa-seedling"></i> Sayur</a>
            <a href="#produk" class="btn btn-switch" id="btnBuah" onclick="switchSection('buah')"><i class="fa-solid fa-apple-whole"></i> Buah</a>
          </div>
        </div>
        
        <a href="https://wa.me/6289618203695" class="whatsapp-float" target="_blank" title="Chat via WhatsApp">
        <i class="fab fa-whatsapp whatsapp-icon"></i>
        </a>
        
      <div id="section-sayur">
  <h2>Daftar Sayur</h2>
  <div id="produkSayurDinamis" class="row row-cols-1 row-cols-md-3 g-4 mt-2"></div>
</div>

<div id="section-buah" class="d-none">
  <h2>Daftar Buah</h2>
  <div id="produkBuahDinamis" class="row row-cols-1 row-cols-md-3 g-4 mt-2"></div>
</div>
</div>

<div id="keranjangOverlay" onclick="toggleKeranjangPopup()" style="display: none;"></div>
<div id="popupKeranjang" class="keranjang-panel">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Keranjang</h5>
    <button class="btn btn-sm btn-outline-danger" onclick="toggleKeranjangPopup()">Tutup</button>
  </div>
  <div id="isiKeranjang" class="overflow-auto" style="max-height: 65vh;"></div>
  <div id="keranjangTotal" class="pt-3 border-top"></div>
</div>
</div>

<div id="riwayatOverlay" onclick="toggleRiwayatPopup()" style="display: none;"></div>
<div id="popupRiwayat" class="riwayat-panel">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Riwayat Transaksi</h5>
    
    <button class="btn btn-sm btn-outline-danger" onclick="toggleRiwayatPopup()">Tutup</button>
  </div>
  <div id="isiRiwayat" class="overflow-auto" style="max-height: 65vh;"></div>
</div>

</body>
<footer class="footer p-4 text-center text-black">
  &copy; 2025 Poedjangga Tani. All rights reserved.
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" ></script>
<script src="assets/js/script.js"></script>

<script>
  function escapeHtmlAttr(str) {
    return String(str).replace(/'/g, "\\'").replace(/\"/g, '\\"');
  }

  async function tampilkanProduk() {
    const containerSayur = document.getElementById('produkSayurDinamis');
    const containerBuah = document.getElementById('produkBuahDinamis');

    containerSayur.innerHTML = "";
    containerBuah.innerHTML = "";

    try {
      const res = await fetch('http://localhost:5000/api/products');
      const data = await res.json();
      console.log("Produk dari server:", data);

      data.forEach(produk => {
        if (!produk._id || !produk.nama || typeof produk.harga === 'undefined') return;

        const div = document.createElement('div');
        div.className = 'col-md-6 col-lg-4 mb-4 produk-card';
        div.dataset.title = produk.nama;

        const namaAman = escapeHtmlAttr(produk.nama);

        div.innerHTML = `
          <div class="card card-clean">
            <img src="${produk.gambar}" alt="${produk.nama}" class="card-img-top" width="400" height="300">
            <div class="card-body">
              <p>${produk.nama}</p>
              <h5 class="card-title">Rp${produk.harga.toLocaleString('id-ID')}/${produk.satuan}</h5>
              <div class="row">
                <div class="col-auto my-auto">
                  <p class="mb-0">${produk.terjual || 0}+ terjual</p>
                </div>
                <div class="col text-end card-footer">
                  <a href="#popupKeranjang" class="btn btn-custom4" onclick="tambahKeKeranjang('${produk._id}', '${namaAman}', ${produk.harga}); toggleKeranjangPopup(); event.preventDefault();">
                    <i class="fa-solid fa-cart-plus"></i></a>
                  <a href="#" class="btn btn-custom3" onclick="belisekarang('${produk._id}', '${namaAman}', ${produk.harga}); toggleKeranjangPopup(); event.preventDefault();">
                  Beli Sekarang</a>
                </div>
              </div>
            </div>
          </div>
        `;

        if ((produk.kategori || '').toLowerCase() === 'buah') {
          containerBuah.appendChild(div);
        } else {
          containerSayur.appendChild(div);
        }
      });
    } catch (err) {
      console.error("Gagal memuat produk:", err);
    }
  }

  function switchSection(kategori) {
    const sayur = document.getElementById("section-sayur");
    const buah = document.getElementById("section-buah");
    const btnSayur = document.getElementById("btnSayur");
    const btnBuah = document.getElementById("btnBuah");

    console.log("Switch ke:", kategori);

    if (kategori === "buah") {
      sayur.classList.add("d-none");
      buah.classList.remove("d-none");
      btnSayur.classList.remove("active");
      btnBuah.classList.add("active");
    } else {
      buah.classList.add("d-none");
      sayur.classList.remove("d-none");
      btnBuah.classList.remove("active");
      btnSayur.classList.add("active");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    tampilkanProduk();

    const btnSayur = document.getElementById("btnSayur");
    const btnBuah = document.getElementById("btnBuah");

    if (btnSayur && btnBuah) {
      btnSayur.addEventListener("click", function (e) {
        e.preventDefault();
        switchSection('sayur');
      });

      btnBuah.addEventListener("click", function (e) {
        e.preventDefault();
        switchSection('buah');
      });
    }

    switchSection('sayur');
  });

  const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "login.html";
  }

  async function loadNamaNavbar() {
    const res = await fetchWithToken("http://localhost:5000/api/auth/profile");
    if (!res || !res.ok) return;
    const data = await res.json();
    const navbar = document.getElementById("namaNavbar");
    if (navbar && data.user?.nama) {
      const username = data.user.username.split(" ")[0];
      navbar.textContent = `Hai, ${username}`;
    }
  }

  document.addEventListener("DOMContentLoaded", loadNamaNavbar);

  function checkSessionExpiration() {
    const expiresAt = localStorage.getItem("expiresAt");
    if (expiresAt && Date.now() > parseInt(expiresAt)) {
      alert("Sesi kamu telah berakhir. Silakan login ulang.");
      localStorage.removeItem("token");
      localStorage.removeItem("expiresAt");
      window.location.href = "login.html";
    }
  }

  checkSessionExpiration();
  setInterval(checkSessionExpiration, 30000);

  function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("expiresAt");
    fetch("http://localhost:5000/api/auth/logout", {
      method: "POST",
      credentials: "include",
    }).finally(() => {
      window.location.href = "login.html";
    });
  }
</script>
</html>