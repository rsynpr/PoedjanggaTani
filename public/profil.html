<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profil Saya - Poedjangga Tani</title>
  <link rel="icon" href="assets/img/logo.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body >
   <nav class="navbar navbar-expand-lg sticky-top px-3">
  <div class="container-fluid d-flex justify-content-between align-items-center">

 
    <a class="navbar-brand text-white fw-bold" href="#home">Poedjangga Tani</a>


    <div class="d-lg-none d-flex align-items-center gap-2">
  
     <button class="navbar-toggler me-2 border-0 bg-white rounded shadow-sm px-2 py-1"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarContent"
        aria-controls="navbarContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
        style="transition: all 0.3s ease;">
  <span class="navbar-toggler-icon"></span>
</button>

    
      <div class="dropdown">
        <a class="text-white nav-link dropdown-toggle d-flex align-items-center" href="#" role="button"
          data-bs-toggle="dropdown" aria-expanded="false">
          <i class="fa-solid fa-circle-user fa-lg me-1"></i>
        </a>
        <ul class="dropdown-menu dropdown-menu-end shadow-sm" style="min-width: 180px;">
          <li><a class="dropdown-item" href="profil.html"><i class="fa-solid fa-user me-2"></i> Profil</a></li>
          <li><a class="dropdown-item" href="keranjang.html"><i class="fa-solid fa-box me-2"></i> Pesanan Saya</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
  <i class="fa-solid fa-arrow-right-from-bracket me-2"></i> Logout
</a></li>
        </ul>
      </div>
    </div>


    <div class="collapse navbar-collapse" id="navbarContent">

      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link text-white" href="index.html#home">Beranda</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="index.html#produk">Produk</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="about.html">Tentang</a></li>
      </ul>

  
      <form class="d-flex mx-auto w-50 justify-content-center" role="search" onsubmit="event.preventDefault(); filterCards();">
        <div class="input-group w-100">
          <input type="text" class="form-control" placeholder="Cari produk segar..." id="cari" onkeyup="filterCards()">
          <button class="btn btn-light" type="button" onclick="filterCards()">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </div>
      </form>

   
      <ul class="navbar-nav ms-auto d-none d-lg-flex">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle d-flex align-items-center text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa-solid fa-circle-user fa-lg me-1"></i>
            <span class="d-none d-md-inline text-white" id="namaNavbar">Akun</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm" style="min-width: 180px;">
            <li><a class="dropdown-item" href="profil.html"><i class="fa-solid fa-user me-2"></i> Profil</a></li>
            <li><a class="dropdown-item" href="keranjang.html"><i class="fa-solid fa-box me-2"></i> Pesanan Saya</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><button onclick="logout()" class="dropdown-item text-danger"><i class="fa-solid fa-right-from-bracket" style="color: #e60000;"></i> Logout</button></li>
          </ul>
        </li>
      </ul>
    </div>

  </div>
</nav>

    <a href="https://wa.me/6289618203695" class="whatsapp-float" target="_blank" title="Chat via WhatsApp">
        <i class="fab fa-whatsapp whatsapp-icon"></i>
        </a>
  <div class="container py-5">
    <div class="card shadow p-4 bg-white border-0">
      <h2 class="mb-4 text-success"><i class="fa-solid fa-user-circle me-2"></i>Profil Saya</h2>
      <form class="profil-info">
        <div class="mb-3">
          <label for="nama" class="form-label fw-bold text-dark" >Nama Lengkap</label>
          <input type="text" class="form-control" id="nama" disabled />
        </div>
        <div class="mb-3">
  <label for="username" class="form-label fw-bold text-dark">Username</label>
  <input type="text" class="form-control" id="username" disabled />
</div>
        <div class="mb-3">
          <label for="email" class="form-label fw-bold text-dark" >Email</label>
          <input type="email" class="form-control" id="email" disabled />
        </div>
        <div class="mb-3">
          <label for="telepon" class="form-label fw-bold text-dark">Nomor Telepon</label>
          <input type="tel" class="form-control" id="telepon" disabled />
        </div>
        <div class="mb-3">
          <label for="alamat" class="form-label fw-bold text-dark" >Alamat Lengkap</label>
          <textarea class="form-control" id="alamat" rows="3" disabled></textarea>
        </div>
   <div class="text-end mt-2">
  <button type="button" class="btn btn-outline-success" id="btnLihatMap">
    <i class="fa-solid fa-map-location-dot me-1"></i> Lihat Map
  </button>
</div>
<br>
        <div class="text-end">
          <button type="button" id="btnEdit" class="btn btn-custom1 px-4">
            <i class="fa-solid fa-pen-to-square me-1"></i> Edit Profil
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
  let isEditing = false;

  function setFormDisabled(disabled) {
    const fields = ["nama", "username", "telepon", "alamat"];
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.disabled = disabled;
    });
  }

  async function fetchWithToken(url, options = {}) {
    let token = localStorage.getItem("token");

    options.headers = {
      ...(options.headers || {}),
      Authorization: "Bearer " + token,
      "Content-Type": "application/json",
    };

    let response = await fetch(url, options);

    if (response.status === 401 || response.status === 403) {
      const refresh = await fetch("http://localhost:5000/api/auth/refresh", {
        method: "POST",
        credentials: "include",
      });

     if (refresh.ok) {
  const data = await refresh.json();
  localStorage.setItem("token", data.accessToken);
  options.headers.Authorization = "Bearer " + data.accessToken;
  response = await fetch(url, options);
      } else {
        alert("Sesi habis. Silakan login ulang.");
        localStorage.removeItem("token");
        window.location.href = "login.html";
        return;
      }
    }

    return response;
  }

 async function loadProfile() {
  console.log(" Memuat profil...");
  const res = await fetchWithToken("http://localhost:5000/api/auth/profile");

  if (!res || !res.ok) {
    console.error("Gagal memuat profil. Status:", res?.status);
    return;
  }

  const data = await res.json();
  console.log("Data profil:", data);

  if (!data.user) {
    console.warn("Data user kosong");
    return;
  }

  document.getElementById("nama").value = data.user.nama || '';
  document.getElementById("username").value = data.user.username || '';
  document.getElementById("email").value = data.user.email || '';
  document.getElementById("telepon").value = data.user.nohp || '';
  document.getElementById("alamat").value = data.user.alamat || '';

  // Tambahkan ini agar navbar juga update
  const navbarNama = document.getElementById("namaNavbar");
  if (navbarNama) {
    const username = data.user.username?.split(" ")[0] || 'Pengguna';
    navbarNama.textContent = `Hai, ${username}`;
  }
}

  async function simpanProfil() {
    const updatedData = {
  nama: document.getElementById("nama").value,
  username: document.getElementById("username").value.split("@")[0], // atau ambil dari field lain
  email: document.getElementById("email").value,
  nohp: document.getElementById("telepon").value,
  alamat: document.getElementById("alamat").value,
};

    const res = await fetchWithToken("http://localhost:5000/api/auth/profile", {
      method: "PUT",
      body: JSON.stringify(updatedData),
    });

    if (!res || !res.ok) {
      alert("Gagal menyimpan profil");
      return;
    }

    const data = await res.json();
    alert("Profil berhasil disimpan!");
  }

  async function toggleEdit() {
    const btn = document.getElementById("btnEdit");

    if (!isEditing) {
      isEditing = true;
      setFormDisabled(false);
      btn.innerHTML = '<i class="fa-solid fa-save me-1"></i> Simpan Profil';
      btn.classList.remove("btn-custom1");
      btn.classList.add("btn-success");
    } else {
      await simpanProfil();
      isEditing = false;
      setFormDisabled(true);
      btn.innerHTML = '<i class="fa-solid fa-pen-to-square me-1"></i> Edit Profil';
      btn.classList.remove("btn-success");
      btn.classList.add("btn-custom1");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnEdit");
    if (btn) {
      btn.addEventListener("click", toggleEdit);
    }
    setFormDisabled(true);
    loadProfile();
  });

function logout() {
  // Hapus token & waktu sesi
  localStorage.removeItem("token");
  localStorage.removeItem("expiresAt");

  // Coba logout dari server (meskipun token kadaluarsa)
  fetch("http://localhost:5000/api/auth/logout", {
    method: "POST",
    credentials: "include",
  }).finally(() => {
    // Tetap arahkan ke login walaupun logout gagal
    window.location.href = "login.html";
  });
}

document.getElementById("btnLihatMap").addEventListener("click", () =>
   {
    let alamat = document.getElementById("alamat").value.trim();

  if (!alamat) {
    alamat = "Poedjangga Tani, Karanglewas, Banyumas, Jawa Tengah, Indonesia";
  } else {
    alamat += ", Indonesia"; // tambahkan agar Maps tidak salah negara
  }

  const encodedAlamat = encodeURIComponent(alamat);
  const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAlamat}`;
  window.open(mapUrl, "_blank");
});
function checkSessionExpiration() {
    const expiresAt = localStorage.getItem("expiresAt");

    if (expiresAt && Date.now() > parseInt(expiresAt)) {
      alert("Sesi kamu telah berakhir. Silakan login ulang.");
      localStorage.removeItem("token");
      localStorage.removeItem("expiresAt");
      window.location.href = "login.html";
    }
  }

  // Cek saat halaman dibuka dan setiap 30 detik
  checkSessionExpiration();
  setInterval(checkSessionExpiration, 30000);
  
</script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
</body>
<footer class="footer p-4 text-center text-black">
  &copy; 2025 Poedjangga Tani. All rights reserved.
</footer>
</html>